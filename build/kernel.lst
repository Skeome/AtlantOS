     1                                  ;=================================================
     2                                  ; AtlantOS - Core Kernel (Simulated Ternary Logic)
     3                                  ;=================================================
     4                                  [BITS 32]
     5                                  [ORG 0x2000]                    ; We will load the kernel at 0x2000
     6                                  
     7                                  kernel_entry:
     8                                      ; Clear the Screen (simple loop)
     9 00000000 BF00800B00                  mov edi, 0xB8000
    10 00000005 B9D0070000                  mov ecx, 80 * 25
    11 0000000A 66B82007                    mov ax, 0x0720              ; Black background, white text, space character
    12 0000000E 66F3AB                      rep stosw
    13                                  
    14                                      ; Setup the "Ternary Test"
    15                                      ; Wee will start with a positive drift and watch it stabilize
    16 00000011 B828000000                  mov eax, 40                 ; Initial Drift Value (+40)
    17 00000016 BF00800B00                  mov edi, 0xB8000            ; Start Writing at top-left
    18                                  
    19                                  stabilize_loop:
    20                                      ; VISUALIZATION 
    21                                      ; We need to save registers because we are about to do math
    22 0000001B 50                          push eax
    23                                  
    24                                      ; Default character: 'X' (Zero/Locked)
    25 0000001C 66B9580A                    mov cx, 0x0A58              ; 'X' character with Light Green color
    26 00000020 83F800                      cmp eax, 0
    27 00000023 740D                        je .draw                    ; If zero, keep 'X'
    28                                  
    29                                      ; If not zero, assume negative first
    30 00000025 66B93C0C                    mov cx, 0x0C3C              ; '<' character with Light Red color
    31 00000029 83F800                      cmp eax, 0
    32 0000002C 7C04                        jl .draw                    ; If less than zero, keep '<'
    33                                  
    34                                      ;Must be positive
    35 0000002E 66B93E0E                    mov cx, 0x0E3E
    36                                  
    37                                  .draw:
    38 00000032 66890F                      mov [edi], cx               ; Write char+color to video memory (WORD write is safer)
    39 00000035 83C702                      add edi, 2                  ; move to next screen cell
    40                                  
    41 00000038 58                          pop eax                     ; Restore our Drift Value
    42                                  
    43                                      ; The (branchless) Ternary Logic
    44                                      ; GOAL: Move EAX toward 0 without using conditional jumps for the math
    45                                  
    46                                      ; Check if 0 (We still need to check if we are done to break the loop)
    47 00000039 83F800                      cmp eax, 0
    48 0000003C 741A                        je .done
    49                                  
    50                                      ; Calculate Sign(EAX) into EBX
    51                                      ; If EAX > 0 --> EBX = 1
    52                                      ; If EAX < 0 --> EBX = -1
    53                                      ; If EAX = 0 --> EBX = 0
    54                                  
    55 0000003E 31DB                        xor ebx, ebx                ; Clear EBX
    56 00000040 31D2                        xor edx, edx                ; Clear EDX
    57                                  
    58 00000042 83F800                      cmp eax, 0
    59 00000045 0F9FC3                      setg bl                     ; If > 0, BL = 1
    60 00000048 0F9CC2                      setl dl                     ; If < 0, DL = 1
    61 0000004B 29D3                        sub ebx, edx                ; EBX = BL - DL. Result is 1, -1, or 0
    62                                  
    63                                      ; Apply the correction
    64 0000004D 29D8                        sub eax, ebx                ; EAX = EAX - Sign(EAX)
    65                                  
    66                                      ; Add tiny delay loop so we can see it happen
    67 0000004F B9FFFFFF00                  mov ecx, 0x00FFFFFF
    68                                  .delay:
    69 00000054 E2FE                        loop .delay
    70 00000056 EBC3                        jmp stabilize_loop
    71                                  
    72                                  .done:
    73                                      ; Print manual "LOCKED" message
    74                                      ; Since we don't have a print function in the kernel yet
    75                                      ; We force EDI to the start of line 2 (Row 1, Col 0)
    76                                      ; Line 1 = 0xB8000, Line 2 = 0xB80A0, Line 3 = 0xB8140
    77 00000058 BFA0800B00                  mov edi, 0xB80A0
    78                                  
    79                                      ; Write 'LOCKED' in Cyan (0x0B)
    80 0000005D 66C7074C0B                  mov word [edi], 0x0B4C      ; 'L'
    81 00000062 66C747024F0B                mov word [edi+2], 0x0B4F    ; 'O'
    82 00000068 66C74704430B                mov word [edi+4], 0x0B43    ; 'C'
    83 0000006E 66C747064B0B                mov word [edi+6], 0x0B4B    ; 'K'
    84 00000074 66C74708450B                mov word [edi+8], 0x0B45    ; 'E'
    85 0000007A 66C7470A440B                mov word [edi+10], 0x0B44   ; 'D'
    86                                  
    87 00000080 EBFE                        jmp $                       ; Hang Forever
    88                                      
